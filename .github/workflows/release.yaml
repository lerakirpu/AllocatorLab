name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  # Отдельный триггер для релизов
  release:
    types: [created]

env:
  VERSION: ${{ github.ref_name || github.event.release.tag_name || '0.0.1' }}

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build on Linux
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update && sudo apt-get install -y g++ cmake make
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        ./build/bin/allocator_lab
        
    - name: Build on Windows
      if: runner.os == 'Windows'
      run: |
        cmake -B build
        cmake --build build --config Release
        .\build\bin\allocator_lab.exe
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ runner.os }}-binary
        path: |
          build/bin/allocator_lab*
          build/bin/*/allocator_lab*

  release:
    needs: build
    if: github.event_name == 'release' && github.event.action == 'created'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        # Переименовываем файлы
        for file in artifacts/*-binary/*; do
          if [[ "$file" == *"windows"* ]]; then
            cp "$file" release-assets/allocator_lab-${{ env.VERSION }}-windows.exe
          elif [[ "$file" == *"ubuntu"* ]]; then
            cp "$file" release-assets/allocator_lab-${{ env.VERSION }}-linux
          fi
        done
        ls -la release-assets/
        
    - name: Upload release assets
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const assets = fs.readdirSync('release-assets');
          
          for (const asset of assets) {
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              name: asset,
              data: fs.readFileSync(`release-assets/${asset}`)
            });
          }